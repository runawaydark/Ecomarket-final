<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Gesti√≥n de Productos | EcoMarket</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link href="assets/css/style.css" rel="stylesheet">
    <style>
        .admin-container {
            background: linear-gradient(135deg, #f1f3f4 0%, #e8eaed 100%);
            min-height: 100vh;
            padding: 1rem 0;
        }
        
        .admin-header {
            background: linear-gradient(135deg, #008c5a, #00b374);
            color: white;
            padding: 1.5rem;
            border-radius: 15px;
            margin-bottom: 1.5rem;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }
        
        .stat-card:hover {
            border-color: #008c5a;
            box-shadow: 0 8px 25px rgba(0, 140, 90, 0.15);
            transform: translateY(-3px);
        }
        
        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            display: block;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #008c5a;
            margin-bottom: 0.25rem;
            display: block;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #6c757d;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Arreglar problema del precio total cortado */
        .order-card .col-md-3:last-child {
            min-width: 160px;
        }

        @media (max-width: 991px) {
            .order-card .col-md-3 {
                margin-bottom: 10px;
            }
            
            .order-total {
                font-size: 1.1rem;
                margin-bottom: 5px;
            }
        }

        /* Responsive styles for mobile */
        @media (max-width: 768px) {
            .admin-container {
                padding: 0.2rem;
            }
            
            .container {
                padding: 0 0.5rem;
            }
            
            .admin-header {
                padding: 0.8rem;
                margin-bottom: 0.8rem;
                border-radius: 8px;
            }
            
            .admin-header h1 {
                font-size: 1.2rem !important;
                margin-bottom: 0.3rem;
            }
            
            .admin-header p {
                font-size: 0.85rem;
                margin-bottom: 0;
            }
            
            /* Botones del header m√°s peque√±os */
            .admin-header .btn {
                font-size: 0.8rem;
                padding: 0.4rem 0.8rem;
                margin-left: 0.3rem;
            }
            
            /* Stats cards m√°s compactas */
            .stats-cards {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.4rem;
                margin-bottom: 0.8rem;
            }
            
            .stat-card {
                padding: 0.6rem !important;
                border-radius: 8px;
            }
            
            .stat-icon {
                font-size: 1.5rem !important;
                margin-bottom: 0.3rem;
            }
            
            .stat-number {
                font-size: 1.1rem !important;
                margin-bottom: 0.2rem;
            }
            
            .stat-label {
                font-size: 0.75rem !important;
            }
            
            /* Secciones de administraci√≥n m√°s compactas */
            .admin-section {
                margin-bottom: 0.8rem !important;
                padding: 0.8rem !important;
                border-radius: 8px;
            }
            
            .admin-section h2 {
                font-size: 1.1rem !important;
                margin-bottom: 0.8rem;
            }
            
            /* Botones de acci√≥n m√°s peque√±os */
            .action-buttons .btn {
                font-size: 0.8rem;
                padding: 0.4rem 0.6rem;
                margin: 0.2rem;
            }
            
            /* Formularios m√°s compactos */
            .row .col-md-4,
            .row .col-md-6,
            .row .col-md-3 {
                margin-bottom: 0.4rem;
            }
            
            .form-label {
                font-size: 0.85rem;
                margin-bottom: 0.2rem;
            }
            
            .form-control {
                font-size: 0.9rem;
                padding: 0.5rem;
            }
            
            .input-group-text {
                font-size: 0.9rem;
                padding: 0.5rem;
            }
            
            /* Product cards responsive */
            .product-card {
                margin-bottom: 1rem;
            }
            
            .product-card .card-body {
                padding: 0.75rem !important;
            }
            
            .product-card h5 {
                font-size: 1rem !important;
            }
            
            .product-card .btn {
                font-size: 0.8rem;
                padding: 0.25rem 0.5rem;
            }
            
            /* Make buttons stack on mobile */
            .btn-group {
                flex-direction: column !important;
                gap: 0.25rem;
            }
            
            .btn-group .btn {
                border-radius: 0.375rem !important;
                margin: 0 !important;
            }
            
            /* Navbar adjustments for mobile admin */
            .badge {
                font-size: 0.7rem;
                padding: 0.25rem 0.4rem;
            }
            
            /* Modal adjustments for mobile */
            .modal-dialog {
                margin: 0.5rem;
            }
            
            .modal-content {
                border-radius: 8px;
            }
            
            .modal-header {
                padding: 0.8rem;
            }
            
            .modal-body {
                padding: 0.8rem;
            }
            
            .modal-footer {
                padding: 0.8rem;
                gap: 0.5rem;
            }
            
            /* Table responsive on mobile */
            .table-responsive {
                font-size: 0.85rem;
            }
            
            .table th,
            .table td {
                padding: 0.4rem !important;
                font-size: 0.8rem;
            }
            
            /* Hide less important columns on small screens */
            .d-none-mobile {
                display: none !important;
            }
            
            /* Filters section responsive */
            .filters-section .row > div {
                margin-bottom: 0.5rem;
            }
            
            .filters-section .btn {
                font-size: 0.85rem;
                padding: 0.4rem 0.6rem;
            }
        }
        
        /* Extra small screens (phones in portrait) */
        @media (max-width: 576px) {
            .admin-header .d-flex {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 0.5rem;
            }
            
            .admin-header .btn {
                font-size: 0.75rem;
                padding: 0.3rem 0.6rem;
            }
            
            .stats-cards {
                grid-template-columns: 1fr 1fr;
                gap: 0.3rem;
            }
            
            .stat-card {
                padding: 0.4rem !important;
            }
            
            .stat-number {
                font-size: 1rem !important;
            }
            
            .stat-label {
                font-size: 0.7rem !important;
            }
            
            .admin-section {
                padding: 0.6rem !important;
            }
            
            .action-buttons {
                flex-direction: column;
                gap: 0.3rem;
            }
            
            .action-buttons .btn {
                font-size: 0.75rem;
                padding: 0.3rem 0.5rem;
                width: 100%;
            }
            
            /* Hide navbar brand text on very small screens */
            .navbar-brand {
                font-size: 0.9rem !important;
            }
            
            /* Make dropdowns full width on mobile */
            .dropdown-menu {
                width: 100% !important;
                min-width: auto !important;
            }
            
            /* Estilos mejorados para dropdowns de estado en m√≥vil */
            .dropdown-menu .dropdown-item {
                padding: 16px 20px !important;
                font-size: 16px !important;
                line-height: 1.5 !important;
                border-bottom: 1px solid #f1f3f4;
                transition: all 0.2s ease;
                white-space: nowrap !important;
                min-height: 50px !important;
                display: flex !important;
                align-items: center !important;
            }
            
            .dropdown-menu .dropdown-item:last-child {
                border-bottom: none;
            }
            
            .dropdown-menu .dropdown-item:hover,
            .dropdown-menu .dropdown-item:focus {
                background-color: #e8f5e8 !important;
                color: #008c5a !important;
                padding-left: 24px !important;
            }
            
            .dropdown-menu .dropdown-item.text-danger:hover {
                background-color: #ffeaea !important;
                color: #dc3545 !important;
            }
            
            /* Bot√≥n dropdown m√°s grande en m√≥vil */
            .btn-group .btn-sm {
                padding: 10px 16px !important;
                font-size: 14px !important;
                min-width: 140px !important;
            }
            
            @media (max-width: 768px) {
                .btn-group .btn-sm {
                    padding: 14px 20px !important;
                    font-size: 16px !important;
                    min-width: 160px !important;
                    width: 100% !important;
                }
            }
            
            /* Separador m√°s visible */
            .dropdown-divider {
                margin: 8px 0 !important;
                border-top: 2px solid #dee2e6 !important;
            }
            
            /* Mejorar contenedor de botones en m√≥vil */
            .order-card .col-md-3 .mt-2 {
                display: flex !important;
                flex-direction: column !important;
                gap: 8px !important;
            }
            
            /* En pantallas m√°s grandes, mantener en fila */
            @media (min-width: 768px) {
                .order-card .col-md-3 .mt-2 {
                    display: flex !important;
                    flex-direction: row !important;
                    gap: 8px !important;
                }
            }
            
            /* Botones m√°s grandes y f√°ciles de tocar */
            .order-card .btn-sm {
                padding: 10px 16px !important;
                font-size: 14px !important;
                min-height: 42px !important;
                white-space: nowrap !important;
            }
            
            /* Dropdown menu m√°s espacioso */
            .btn-group .dropdown-menu {
                min-width: 220px !important;
                width: 220px !important;
                padding: 12px 0 !important;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15) !important;
                border: 1px solid #e0e0e0 !important;
                border-radius: 8px !important;
                margin-top: 4px !important;
            }
            
            /* En m√≥vil hacer el dropdown a√∫n m√°s grande */
            @media (max-width: 768px) {
                .btn-group .dropdown-menu {
                    min-width: 280px !important;
                    width: 280px !important;
                    padding: 16px 0 !important;
                    font-size: 18px !important;
                }
                
                .dropdown-menu .dropdown-item {
                    padding: 18px 24px !important;
                    font-size: 18px !important;
                    min-height: 56px !important;
                }
                
                .dropdown-menu .dropdown-item:hover,
                .dropdown-menu .dropdown-item:focus {
                    padding-left: 28px !important;
                }
            }
            
            /* Reduce navbar padding on mobile */
            .navbar {
                padding: 0.25rem 0.5rem !important;
            }
            
            .navbar-nav .nav-link {
                padding: 0.3rem 0.5rem !important;
                font-size: 0.85rem !important;
            }
        }
        
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
            border: 1px solid rgba(0, 140, 90, 0.1);
        }
        
        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            color: #008c5a;
        }
        
        .stat-number {
            font-size: 1.8rem;
            font-weight: bold;
            color: #333;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }
        
        .admin-section {
            background: #ffffff;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border: 2px solid #f1f3f4;
            position: relative;
        }
        
        .admin-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #008c5a 0%, #00a862 100%);
            border-radius: 15px 15px 0 0;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .btn-primary-custom {
            background: linear-gradient(135deg, #008c5a, #00b374);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary-custom:hover {
            background: linear-gradient(135deg, #007a50, #009d66);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 140, 90, 0.3);
        }
        
        .product-item {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }
        
        .product-item:hover {
            border-color: #008c5a;
            box-shadow: 0 4px 15px rgba(0, 140, 90, 0.1);
        }
        
        .product-form {
            background: #ffffff;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .form-control {
            background-color: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .form-control:focus {
            background-color: #ffffff;
            border-color: #008c5a;
            box-shadow: 0 0 0 3px rgba(0, 140, 90, 0.15), 0 4px 8px rgba(0, 0, 0, 0.1);
            outline: none;
        }
        
        .form-control:hover {
            border-color: #ced4da;
            background-color: #ffffff;
        }
        
        .form-control::placeholder {
            color: #6c757d;
            opacity: 0.8;
        }
        
        /* Estilos espec√≠ficos para inputs de n√∫meros */
        input[type="number"].form-control {
            background-image: linear-gradient(45deg, transparent 49%, #f8f9fa 49%, #f8f9fa 51%, transparent 51%);
            background-size: 20px 20px;
            background-repeat: no-repeat;
            background-position: right 10px center;
        }
        
        /* Estilos para select */
        select.form-control {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.75rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
        
        /* Estilos para textarea */
        textarea.form-control {
            resize: vertical;
            min-height: 100px;
        }
        
        /* Labels mejorados */
        .form-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.5rem;
        }
        
        /* Contenedor de campos mejorado */
        .mb-3 {
            position: relative;
        }
        
        /* Estilos para checkboxes mejorados */
        .form-check-input {
            width: 1.2rem;
            height: 1.2rem;
            margin-top: 0.25rem;
            border: 2px solid #dee2e6;
            border-radius: 4px;
            background-color: #ffffff;
        }
        
        .form-check-input:checked {
            background-color: #008c5a;
            border-color: #008c5a;
        }
        
        .form-check-input:focus {
            border-color: #008c5a;
            box-shadow: 0 0 0 3px rgba(0, 140, 90, 0.15);
        }
        
        .form-check-label {
            font-weight: 500;
            color: #495057;
        }
        
        /* Botones mejorados */
        .btn {
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            border-radius: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        /* Estilos para secciones colapsables */
        .section-header[data-bs-toggle="collapse"] {
            transition: all 0.3s ease;
            border-radius: 8px;
            padding: 0.5rem;
            margin: -0.5rem;
        }
        
        .section-header[data-bs-toggle="collapse"]:hover {
            background-color: rgba(0, 140, 90, 0.05);
        }
        
        .collapse-icon {
            transition: transform 0.3s ease;
            color: #008c5a;
        }
        
        .section-header[aria-expanded="true"] .collapse-icon {
            transform: rotate(180deg);
        }

        /* Estilos para tarjetas de pedidos */
        .order-card {
            background: #ffffff;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .order-card:hover {
            border-color: #008c5a;
            box-shadow: 0 4px 15px rgba(0, 140, 90, 0.1);
        }
        
        .order-status {
            position: absolute;
            top: -10px;
            right: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .order-total {
            font-size: 1.2rem;
            font-weight: bold;
            color: #008c5a;
            white-space: nowrap;
            overflow: visible;
            text-overflow: clip;
        }
        
        .order-items {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 0.75rem;
            margin: 0.5rem 0;
        }
        
        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.25rem;
        }
        
        .order-item:last-child {
            margin-bottom: 0;
        }

        /* Estilos para gr√°ficos y reportes */
        .report-chart {
            background: #ffffff;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .progress-category {
            height: 8px;
            border-radius: 4px;
            margin-bottom: 0.5rem;
        }
        
        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .category-item:last-child {
            border-bottom: none;
        }
        
        .ranking-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .ranking-item:last-child {
            border-bottom: none;
        }
        
        .ranking-number {
            background: #008c5a;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 1rem;
        }
        
        .ranking-number.gold {
            background: #ffc107;
            color: #000;
        }
        
        .ranking-number.silver {
            background: #6c757d;
        }
        
        .ranking-number.bronze {
            background: #fd7e14;
        }

        /* Animaciones para las tarjetas */
        .admin-section {
            transition: all 0.3s ease;
        }
        
        .admin-section:hover {
            transform: translateY(-2px);
        }

        /* Badges de estado mejorados */
        .status-badge {
            font-size: 0.75rem;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-confirmado {
            background-color: #e3f2fd;
            color: #1976d2;
        }
        
        .status-procesando {
            background-color: #fff3e0;
            color: #f57c00;
        }
        
        .status-enviado {
            background-color: #f3e5f5;
            color: #7b1fa2;
        }
        
        .status-entregado {
            background-color: #e8f5e8;
            color: #2e7d32;
        }
        
        .status-cancelado {
            background-color: #ffebee;
            color: #c62828;
        }

        /* Sistema de notificaciones elegante */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            min-width: 300px;
            max-width: 400px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #008c5a;
            z-index: 1050;
            overflow: hidden;
            animation: slideInRight 0.3s ease-out;
        }

        .notification.success { border-left-color: #28a745; }
        .notification.error { border-left-color: #dc3545; }
        .notification.warning { border-left-color: #ffc107; }
        .notification.info { border-left-color: #17a2b8; }

        .notification-header {
            padding: 16px 20px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .notification-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .notification-icon.success { background: #d4edda; color: #155724; }
        .notification-icon.error { background: #f8d7da; color: #721c24; }
        .notification-icon.warning { background: #fff3cd; color: #856404; }
        .notification-icon.info { background: #d1ecf1; color: #0c5460; }

        .notification-content {
            flex: 1;
        }

        .notification-message {
            color: #2c3e50;
            font-size: 14px;
            line-height: 1.4;
            margin: 0;
        }

        .notification-close {
            background: none;
            border: none;
            color: #6c757d;
            font-size: 18px;
            cursor: pointer;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s;
        }

        .notification-close:hover {
            background-color: #f8f9fa;
        }

        .notification-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: linear-gradient(90deg, #008c5a, #00b374);
            transition: width 0.1s linear;
        }

        .notification.success .notification-progress { background: linear-gradient(90deg, #28a745, #34ce57); }
        .notification.error .notification-progress { background: linear-gradient(90deg, #dc3545, #e74c3c); }
        .notification.warning .notification-progress { background: linear-gradient(90deg, #ffc107, #f39c12); }
        .notification.info .notification-progress { background: linear-gradient(90deg, #17a2b8, #3498db); }

        @keyframes slideInRight {
            from { 
                transform: translateX(100%); 
                opacity: 0; 
            }
            to { 
                transform: translateX(0); 
                opacity: 1; 
            }
        }

        @keyframes slideOutRight {
            from { 
                transform: translateX(0); 
                opacity: 1; 
            }
            to { 
                transform: translateX(100%); 
                opacity: 0; 
            }
        }

        /* Responsive para notificaciones */
        @media (max-width: 768px) {
            .notification {
                right: 10px;
                left: 10px;
                min-width: auto;
                max-width: none;
            }
        }

        /* Mejoras m√≥viles simples */
        @media (max-width: 768px) {
            .admin-header {
                padding: 0.5rem !important;
            }
            
            .admin-header h1 {
                font-size: 1.1rem !important;
            }
            
            .stats-cards {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 0.8rem !important;
            }
            
            .stat-card {
                padding: 1rem !important;
            }
            
            .stat-icon {
                font-size: 2rem !important;
                margin-bottom: 0.4rem !important;
            }
            
            .stat-number {
                font-size: 1.5rem !important;
                margin-bottom: 0.2rem !important;
            }
            
            .stat-label {
                font-size: 0.75rem !important;
            }
            
            .admin-section {
                margin-bottom: 2.5rem !important;
                padding: 0 !important;
            }
            
            .section-header h3 {
                font-size: 0.95rem !important;
            }
            
            .form-control, .form-select {
                font-size: 16px !important; /* Prevenir zoom en iOS */
                padding: 0.6rem !important;
            }
            
            .btn {
                font-size: 0.85rem !important;
                padding: 0.5rem 0.8rem !important;
            }
            
            .btn-group {
                flex-direction: column !important;
                gap: 0.3rem !important;
            }
            
            .btn-group .btn {
                border-radius: 0.375rem !important;
            }
            
            .order-card {
                padding: 0.8rem !important;
                margin-bottom: 0.8rem !important;
            }
            
            .order-card .col-md-3 {
                margin-bottom: 0.5rem !important;
            }
            
            .modal-dialog {
                margin: 0.5rem !important;
            }
        }

        /* Pantallas extra peque√±as - una columna */
        @media (max-width: 480px) {
            .stats-cards {
                grid-template-columns: 1fr !important;
                gap: 0.6rem !important;
            }
            
            .stat-card {
                padding: 0.8rem !important;
            }
            
            .stat-icon {
                font-size: 1.8rem !important;
            }
            
            .stat-number {
                font-size: 1.3rem !important;
            }
            
            .stat-label {
                font-size: 0.7rem !important;
            }
        }

        /* Pantallas extra peque√±as */
        @media (max-width: 576px) {
            .admin-header h1 {
                font-size: 1rem !important;
            }
            
            .stat-card {
                padding: 0.8rem !important;
            }
            
            .stat-number {
                font-size: 1.2rem !important;
            }
            
            .mobile-order-actions {
                flex-direction: column !important;
            }
            
            .mobile-order-actions .btn {
                min-width: auto !important;
                flex: none !important;
            }
        }
    </style>
</head>
<body>
    <!-- NAVBAR EST√ÅNDAR ECOMARKET -->
    <nav class="navbar navbar-expand-lg navbar-dark sticky-top" style="background-color: #008c5a;">
    <div class="container-fluid">
        <!-- Logo -->
        <a class="navbar-brand fw-bold" href="index.html">EcoMarket</a>

        <!-- Iconos fijos a la derecha (siempre visibles) -->
        <div class="d-flex align-items-center gap-2 order-lg-3">
            <!-- Dropdown Usuario -->
            <div class="dropdown">
                <a href="#" class="text-white" role="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-person fs-5"></i>
                </a>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown" id="userDropdownMenu">
                    <!-- El contenido se genera din√°micamente con JavaScript -->
                </ul>
            </div>

            <!-- Carrito -->
            <a href="carrito.html" class="text-white position-relative">
                <i class="bi bi-cart fs-5"></i>
                <!-- Contador din√°mico -->
                <span id="cart-count" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="display: none;">
                0
                </span>  
            </a>

            <!-- Indicador Admin -->
            <span class="badge bg-warning text-dark">
                <i class="bi bi-shield-check me-1"></i>Admin
            </span>
        </div>

        <!-- Bot√≥n Hamburguesa (corregido) -->
        <button class="navbar-toggler custom-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="custom-toggler-icon">
                <span></span>
                <span></span>
                <span></span>
            </span>
        </button>

        <!-- Links del men√∫ -->
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item"><a class="nav-link" href="index.html">Inicio</a></li>
                <li class="nav-item"><a class="nav-link" href="catalogo.html">Cat√°logo</a></li>
                <li class="nav-item"><a class="nav-link active" href="admin.html">Admin</a></li>
                <li class="nav-item"><a class="nav-link" href="nosotros.html">Nosotros</a></li>
                <li class="nav-item"><a class="nav-link" href="contacto.html">Contacto</a></li>
            </ul>
        </div>
    </div>
    </nav>

    <div class="admin-container">
        <div class="container">
            <!-- Header -->
            <div class="admin-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1><i class="bi bi-gear-fill"></i> Panel de Administraci√≥n</h1>
                        <p class="mb-0">Gestiona los productos del cat√°logo EcoMarket</p>
                    </div>
                    <div class="d-flex gap-2">
                        <a href="catalogo.html" class="btn btn-light">
                            <i class="bi bi-eye"></i> Ver Cat√°logo
                        </a>
                        <button class="btn btn-outline-light" onclick="logout()">
                            <i class="bi bi-box-arrow-right"></i> Cerrar Sesi√≥n
                        </button>
                    </div>
                </div>
            </div>

            <!-- Estad√≠sticas -->
            <div class="stats-cards">
                <div class="stat-card">
                    <div class="stat-icon">üì¶</div>
                    <div class="stat-number" id="total-products">0</div>
                    <div class="stat-label">Total Productos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚úÖ</div>
                    <div class="stat-number" id="in-stock">0</div>
                    <div class="stat-label">En Stock</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚ö†Ô∏è</div>
                    <div class="stat-number" id="low-stock">0</div>
                    <div class="stat-label">Poco Stock</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üí∞</div>
                    <div class="stat-number" id="avg-price">$0</div>
                    <div class="stat-label">Precio Promedio</div>
                </div>
            </div>

            <!-- Formulario para agregar/editar productos -->
            <div class="admin-section">
                <div class="section-header" data-bs-toggle="collapse" data-bs-target="#collapse-add-product" aria-expanded="false" aria-controls="collapse-add-product" style="cursor: pointer;">
                    <h3><i class="bi bi-plus-circle"></i> Agregar/Editar Producto <i class="bi bi-chevron-down ms-2 collapse-icon"></i></h3>
                    <button class="btn btn-secondary" onclick="clearForm()" data-bs-toggle="tooltip" title="Limpiar todos los campos">
                        <i class="bi bi-x-circle"></i> Limpiar Formulario
                    </button>
                </div>
                
                <div class="collapse" id="collapse-add-product">
                
                <form class="product-form" id="product-form">
                    <input type="hidden" id="product-id">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nombre del Producto *</label>
                            <input type="text" class="form-control" id="product-name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Categor√≠a *</label>
                            <select class="form-control" id="product-category" required>
                                <option value="">Seleccionar categor√≠a</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Descripci√≥n *</label>
                        <textarea class="form-control" id="product-description" rows="3" required></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 col-12 mb-3">
                            <label class="form-label">Precio oferta *</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="product-price" required>
                            </div>
                        </div>
                        <div class="col-md-4 col-12 mb-3">
                            <label class="form-label">Precio Original</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="product-original-price">
                            </div>
                        </div>
                        <div class="col-md-4 col-12 mb-3">
                            <label class="form-label">Unidad *</label>
                            <select class="form-control" id="product-unit" required>
                                <option value="kg">Kilogramo (kg)</option>
                                <option value="unidad">Unidad</option>
                                <option value="litro">Litro</option>
                                <option value="paquete">Paquete</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 col-12 mb-3">
                            <label class="form-label">Stock Actual *</label>
                            <input type="number" class="form-control" id="product-stock" min="0" required>
                        </div>
                        <div class="col-md-4 col-12 mb-3">
                            <label class="form-label">Stock M√°ximo *</label>
                            <input type="number" class="form-control" id="product-max-stock" min="1" required>
                        </div>
                        <div class="col-md-4 col-12 mb-3">
                            <label class="form-label">Calificaci√≥n</label>
                            <input type="number" class="form-control" id="product-rating" min="0" max="5" step="0.1" value="4.0">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 col-12 mb-3">
                            <label class="form-label">URL de Imagen</label>
                            <input type="url" class="form-control" id="product-image" placeholder="https://ejemplo.com/imagen.jpg">
                        </div>
                        <div class="col-md-6 col-12 mb-3">
                            <label class="form-label">N√∫mero de Rese√±as</label>
                            <input type="number" class="form-control" id="product-reviews" min="0" value="0">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6 col-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="product-is-new">
                                <label class="form-check-label" for="product-is-new">
                                    Producto Nuevo
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6 col-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="product-available" checked>
                                <label class="form-check-label" for="product-available">
                                    Disponible
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary-custom">
                        <i class="bi bi-save"></i> <span id="form-btn-text">Guardar Producto</span>
                    </button>
                </form>
                </div>
            </div>

            <!-- Lista de productos existentes -->
            <div class="admin-section">
                <div class="section-header" data-bs-toggle="collapse" data-bs-target="#collapse-products" aria-expanded="false" aria-controls="collapse-products" style="cursor: pointer;">
                    <h3><i class="bi bi-list-ul"></i> Productos Existentes <i class="bi bi-chevron-down ms-2 collapse-icon"></i></h3>
                    <button class="btn btn-warning" onclick="resetToDefaults()" data-bs-toggle="tooltip" title="Restaurar productos por defecto">
                        <i class="bi bi-arrow-clockwise"></i> Restaurar Valores por Defecto
                    </button>
                </div>
                
                <div class="collapse" id="collapse-products">
                
                    <div id="products-list">
                        <!-- Los productos se cargan din√°micamente aqu√≠ -->
                    </div>
                </div>
            </div>

            <!-- Gesti√≥n de Pedidos Pendientes -->
            <div class="admin-section">
                <div class="section-header" data-bs-toggle="collapse" data-bs-target="#collapse-orders" aria-expanded="false" aria-controls="collapse-orders" style="cursor: pointer;">
                    <h3><i class="bi bi-clock-history"></i> Pedidos Pendientes <i class="bi bi-chevron-down ms-2 collapse-icon"></i></h3>
                    <div class="d-flex gap-2">
                        <button class="btn btn-info btn-sm" onclick="generateTestOrders()" data-bs-toggle="tooltip" title="Generar pedidos de prueba con productos reales">
                            <i class="bi bi-plus-circle"></i> Generar Prueba
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="clearAllOrders()" data-bs-toggle="tooltip" title="Limpiar todos los pedidos antiguos">
                            <i class="bi bi-trash3"></i> Limpiar Todo
                        </button>
                        <button class="btn btn-success btn-sm" onclick="refreshOrders()" data-bs-toggle="tooltip" title="Actualizar lista de pedidos">
                            <i class="bi bi-arrow-clockwise"></i> Actualizar
                        </button>
                        <span class="badge bg-warning text-dark fs-6" id="pending-orders-count">0</span>
                    </div>
                </div>
                
                <div class="collapse" id="collapse-orders">
                    <!-- Filtros de pedidos -->
                    <div class="mb-3 p-3 bg-light rounded">
                        <div class="row align-items-center">
                            <div class="col-md-3">
                                <label class="form-label">Filtrar por estado:</label>
                                <select class="form-control form-control-sm" id="order-status-filter" onchange="filterOrders()">
                                    <option value="">Todos los estados</option>
                                    <option value="confirmado">Confirmados</option>
                                    <option value="procesando">Procesando</option>
                                    <option value="enviado">Enviados</option>
                                    <option value="entregado">Entregados</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">M√©todo de pago:</label>
                                <select class="form-control form-control-sm" id="payment-filter" onchange="filterOrders()">
                                    <option value="">Todos los m√©todos</option>
                                    <option value="credit-card">Tarjeta de Cr√©dito</option>
                                    <option value="bank-transfer">Transferencia</option>
                                    <option value="cash-on-delivery">Contra Entrega</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Buscar cliente:</label>
                                <input type="text" class="form-control form-control-sm" id="customer-search" placeholder="Nombre o email..." onkeyup="filterOrders()">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">&nbsp;</label>
                                <button class="btn btn-outline-secondary btn-sm w-100" onclick="clearOrderFilters()">
                                    <i class="bi bi-x"></i> Limpiar
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="orders-list">
                        <!-- Los pedidos se cargan din√°micamente aqu√≠ -->
                    </div>
                </div>
            </div>

            <!-- Informes y Estad√≠sticas -->
            <div class="admin-section">
                <div class="section-header" data-bs-toggle="collapse" data-bs-target="#collapse-reports" aria-expanded="false" aria-controls="collapse-reports" style="cursor: pointer;">
                    <h3><i class="bi bi-graph-up"></i> Informes y Estad√≠sticas <i class="bi bi-chevron-down ms-2 collapse-icon"></i></h3>
                    <div class="d-flex gap-2">
                        <button class="btn btn-info btn-sm" onclick="generateReport()" data-bs-toggle="tooltip" title="Generar nuevo informe">
                            <i class="bi bi-file-earmark-bar-graph"></i> Generar Informe
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="exportReport()" data-bs-toggle="tooltip" title="Exportar datos">
                            <i class="bi bi-download"></i> Exportar
                        </button>
                    </div>
                </div>
                
                <div class="collapse" id="collapse-reports">
                    <!-- M√©tricas principales -->
                    <div class="row mb-4">
                        <div class="col-md-3 mb-3">
                            <div class="stat-card">
                                <div class="stat-icon text-primary">üìä</div>
                                <div class="stat-number" id="total-sales">$0</div>
                                <div class="stat-label">Ventas Totales</div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="stat-card">
                                <div class="stat-icon text-success">üèÜ</div>
                                <div class="stat-number" id="best-seller">-</div>
                                <div class="stat-label">M√°s Vendido</div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="stat-card">
                                <div class="stat-icon text-info">üë§</div>
                                <div class="stat-number" id="top-customer">-</div>
                                <div class="stat-label">Cliente Top</div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="stat-card">
                                <div class="stat-icon text-warning">üì¶</div>
                                <div class="stat-number" id="pending-deliveries">0</div>
                                <div class="stat-label">Pendientes</div>
                            </div>
                        </div>
                    </div>

                    <!-- Tablas de reportes -->
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h5 class="mb-0"><i class="bi bi-trophy"></i> Top 5 Productos M√°s Vendidos</h5>
                                </div>
                                <div class="card-body">
                                    <div id="top-products-list">
                                        <!-- Lista generada din√°micamente -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h5 class="mb-0"><i class="bi bi-people"></i> Top 5 Clientes</h5>
                                </div>
                                <div class="card-body">
                                    <div id="top-customers-list">
                                        <!-- Lista generada din√°micamente -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Resumen de pedidos por categor√≠a -->
                    <div class="card">
                        <div class="card-header bg-light">
                            <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Ventas por Categor√≠a</h5>
                        </div>
                        <div class="card-body">
                            <div class="row" id="category-stats">
                                <!-- Estad√≠sticas por categor√≠a generadas din√°micamente -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/api.js"></script>
    <script>
        let isEditing = false;

        function showNotification(message, type = 'success', duration = 4000) {
            const notificationId = 'notification-' + Date.now();
            
            const icons = {
                success: '<i class="bi bi-check-circle-fill"></i>',
                error: '<i class="bi bi-x-circle-fill"></i>',
                warning: '<i class="bi bi-exclamation-triangle-fill"></i>',
                info: '<i class="bi bi-info-circle-fill"></i>'
            };

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.id = notificationId;
            notification.innerHTML = `
                <div class="notification-header">
                    <div class="d-flex align-items-start">
                        <div class="notification-icon ${type}">
                            ${icons[type]}
                        </div>
                        <div class="notification-content">
                            <p class="notification-message">${message}</p>
                        </div>
                        <button class="notification-close" onclick="closeNotification('${notificationId}')">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                </div>
                <div class="notification-progress" style="width: 100%"></div>
            `;

            document.body.appendChild(notification);

            setTimeout(() => {
                const progressBar = notification.querySelector('.notification-progress');
                if (progressBar) {
                    progressBar.style.width = '0%';
                    progressBar.style.transition = `width ${duration}ms linear`;
                }
            }, 100);

            setTimeout(() => {
                closeNotification(notificationId);
            }, duration);

            return notificationId;
        }

        function closeNotification(notificationId) {
            const notification = document.getElementById(notificationId);
            if (notification) {
                notification.style.animation = 'slideOutRight 0.3s ease-out';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }
        }

        let adminProducts = [];

async function syncProductsFromBackendToLocalStorage() {    
    try {
        const backendProducts = await apiGet("/products");
    
        const mapped = backendProducts.map(p => {
            const categoryId = p.category?._id || p.category || "";
            const categoryName = p.category?.name || "";

            return {
                id: p._id,
                name: p.name,
                categoryId: categoryId,
                categoryLabel: categoryName || "general",
                description: p.description || "",
                price: p.price ?? 0,
                originalPrice: p.originalPrice ?? null,
                unit: p.unit || "unidad",
                stock: p.stock ?? 0,
                maxStock: p.maxStock ?? 100,
                image: p.imageUrl || "",
                rating: p.rating ?? 4,
                reviews: p.reviews ?? 0,
                isNew: !!p.isNew,
                isOffer: !!p.isOffer,
                available: p.active ?? true
            };
        });
    
        saveProducts(mapped);

        renderProductsList();
        updateStats();

        console.log("Productos sincronizados desde backend:", mapped);
    } catch (error) {
        console.error("Error sincronizando productos desde backend:", error);
        showNotification("Error al cargar productos desde el servidor", "error");
    }
}

async function loadCategoriesForAdmin() {
    const select = document.getElementById('product-category');
    if (!select) return;

    try {
        const categories = await apiGet('/categories');
        select.innerHTML = '<option value="">Seleccionar categor√≠a</option>';

        categories.forEach(cat => {
            select.innerHTML += `<option value="${cat._id}">${cat.name}</option>`;
        });
    } catch (error) {
        console.error('Error cargando categor√≠as:', error);
        showNotification('No se pudieron cargar las categor√≠as', 'error');
    }
}

function getProducts() {
    return adminProducts;
}

function saveProducts(products) {
    adminProducts = products;
    window.dispatchEvent(new CustomEvent('productsUpdated', { detail: products }));
}

// Actualizar estad√≠sticas usando adminProducts
function updateStats() {
    const products = getProducts();
    const totalProducts = products.length;
    const inStock = products.filter(p => p.stock > 5).length;
    const lowStock = products.filter(p => p.stock <= 5 && p.stock > 0).length;
    const avgPrice = products.length > 0 ?
        Math.round(products.reduce((sum, p) => sum + (p.price || 0), 0) / products.length) : 0;

    document.getElementById('total-products').textContent = totalProducts;
    document.getElementById('in-stock').textContent = inStock;
    document.getElementById('low-stock').textContent = lowStock;
    document.getElementById('avg-price').textContent = '$' + avgPrice.toLocaleString('es-CL');
}

function renderProductsList() {
    const products = getProducts();
    const container = document.getElementById('products-list');

    if (!container) return;

    if (!products || !products.length) {
        container.innerHTML = `
            <div class="text-center text-muted py-5">
                <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                <h5>No hay productos registrados</h5>
                <p>Agrega tu primer producto usando el formulario de arriba</p>
            </div>`;
        return;
    }

    container.innerHTML = products.map(product => {
        const imageSrc =
            product.image ||
            product.imageUrl ||
            'https://via.placeholder.com/80x60/008c5a/ffffff?text=Sin+Img';

        const isActive = product.available ?? true;
        const statusBadgeClass = isActive ? 'bg-success' : 'bg-secondary';
        const statusText = isActive ? 'Activo' : 'Inactivo';
        const stock = product.stock ?? 0;
        const maxStock = product.maxStock ?? 0;
        const progressPercent = maxStock ? Math.min(100, (stock / maxStock) * 100) : 0;

        return `
        <div class="product-item">
            <div class="row align-items-center">
                <div class="col-md-2">
                    <img src="${imageSrc}"
                            class="img-fluid rounded" alt="${product.name}"
                            style="height: 60px; object-fit: cover;">
                </div>
                <div class="col-md-3">
                    <h6 class="mb-1">${product.name}</h6>
                    <span class="badge bg-secondary">${product.categoryLabel || 'general'}</span>
                </div>
                <div class="col-md-2">
                    <div class="fw-bold text-success">
                        $${(product.price || 0).toLocaleString('es-CL')}
                    </div>
                    <small class="text-muted">por ${product.unit || 'unidad'}</small>
                </div>
                <div class="col-md-2">
                    <div class="d-flex align-items-center">
                        <span class="me-2">${stock}</span>
                        <div class="progress" style="width: 60px; height: 8px;">
                            <div class="progress-bar ${stock > 5 ? 'bg-success' : 'bg-warning'}"
                                    style="width: ${progressPercent}%">
                            </div>
                        </div>
                    </div>
                    <small class="text-muted">de ${maxStock || '-'}</small>
                </div>
                <div class="col-md-1 text-center">
                    <span class="badge ${statusBadgeClass}">
                        ${statusText}
                    </span>
                </div>
                <div class="col-md-2 text-end">
                    <button class="btn btn-sm btn-outline-primary me-1"
                            onclick="editProduct('${product.id}')">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-warning me-1"
                            onclick="toggleProductActive('${product.id}')">
                        ${isActive
                            ? '<i class="bi bi-eye-slash"></i>'
                            : '<i class="bi bi-eye"></i>'}
                    </button>
                    <button class="btn btn-sm btn-outline-danger"
                            onclick="deleteProduct('${product.id}')">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        </div>`;
    }).join('');
}

function clearForm() {
    document.getElementById('product-form').reset();
    document.getElementById('product-id').value = '';
    document.getElementById('product-available').checked = true;
    document.getElementById('product-rating').value = 4.0;
    document.getElementById('product-reviews').value = 0;
    document.getElementById('form-btn-text').textContent = 'Guardar Producto';
    isEditing = false;
}

function editProduct(productId) {
    const products = getProducts();
    const product = products.find(p => p.id === productId);
    if (!product) return;

    document.getElementById('product-id').value = product.id;
    document.getElementById('product-name').value = product.name;
    document.getElementById('product-category').value = product.categoryId || product.category || '';
    document.getElementById('product-description').value = product.description;
    document.getElementById('product-price').value = product.price;
    document.getElementById('product-original-price').value = product.originalPrice || '';
    document.getElementById('product-unit').value = product.unit;
    document.getElementById('product-stock').value = product.stock;
    document.getElementById('product-max-stock').value = product.maxStock;
    document.getElementById('product-rating').value = product.rating;
    document.getElementById('product-image').value = product.image || product.imageUrl || '';
    document.getElementById('product-reviews').value = product.reviews;
    document.getElementById('product-is-new').checked = product.isNew;
    document.getElementById('product-available').checked = product.available;

    document.getElementById('form-btn-text').textContent = 'Actualizar Producto';
    isEditing = true;
    document.getElementById('product-form').scrollIntoView({ behavior: 'smooth' });
}

function deleteProduct(productId) {
    showConfirmation(
        '¬øEst√°s seguro de que deseas eliminar este producto?',
        async function () {
            try {
                await apiDelete(`/products/${productId}`);
                adminProducts = adminProducts.filter(p => p.id !== productId);
                renderProductsList();
                updateStats();
                showNotification('Producto eliminado correctamente', 'success');
            } catch (error) {
                console.error('Error eliminando producto:', error);
                showNotification('Error al eliminar producto en el servidor', 'error');
            }
        }
    );
}

async function toggleProductActive(productId) {
    const product = adminProducts.find(p => p.id === productId);
    if (!product) return;

    const newActive = !(product.available ?? true);

    try {
        await apiPut(`/products/${productId}`, { active: newActive });
        product.available = newActive;

        renderProductsList();
        updateStats();

        showNotification(
            newActive ? 'Producto activado correctamente' : 'Producto desactivado correctamente',
            'success'
        );
    } catch (error) {
        console.error('Error cambiando estado de producto:', error);
        showNotification('No se pudo cambiar el estado del producto', 'error');
    }
}

function resetToDefaults() {
    showConfirmation(
        '¬øEst√°s seguro? Esto eliminar√° todos los productos actuales y restaurar√° los valores por defecto en la base de datos.',
        async function () {
            const defaultProducts = [
                {
                    name: 'Frutillas Frescas Premium',
                    category: 'frutas',
                    description: 'Frutillas de temporada, dulces y jugosas. Perfectas para postres y desayunos saludables.',
                    price: 1600,
                    originalPrice: 2000,
                    unit: 'kg',
                    stock: 15,
                    maxStock: 20,
                    imageUrl: 'assets/img/frutillas.jpg',
                    rating: 4.5,
                    reviews: 24,
                    isNew: false,
                    isOffer: true,
                    available: true
                },
                {
                    name: 'Lechuga Criolla Fresca',
                    category: 'verduras',
                    description: 'Lechuga criolla de hoja verde, crujiente y fresca. Ideal para ensaladas y hamburguesas.',
                    price: 1200,
                    originalPrice: null,
                    unit: 'unidad',
                    stock: 25,
                    maxStock: 30,
                    imageUrl: 'assets/img/lechuga.jpg',
                    rating: 4.0,
                    reviews: 18,
                    isNew: false,
                    isOffer: false,
                    available: true
                },
                {
                    name: 'Tomates Cherry Org√°nicos',
                    category: 'verduras',
                    description: 'Tomates cherry org√°nicos, dulces y jugosos. Perfectos para ensaladas y snacks saludables.',
                    price: 2800,
                    originalPrice: null,
                    unit: 'kg',
                    stock: 3,
                    maxStock: 20,
                    imageUrl: 'assets/img/tomates.jpg',
                    rating: 5.0,
                    reviews: 32,
                    isNew: false,
                    isOffer: false,
                    available: true
                },
                {
                    name: 'Zanahorias Baby Premium',
                    category: 'verduras',
                    description: 'Zanahorias baby tiernas y dulces. Ideales para cocinar o consumir crudas como snack saludable.',
                    price: 1800,
                    originalPrice: null,
                    unit: 'kg',
                    stock: 20,
                    maxStock: 25,
                    imageUrl: 'assets/img/zanahoria.jpg',
                    rating: 4.2,
                    reviews: 12,
                    isNew: true,
                    isOffer: false,
                    available: true
                }
            ];

            try {
                // 1) borrar todos los productos actuales
                const current = await apiGet("/products");
                await Promise.all(current.map(p => apiDelete(`/products/${p._id}`)));

                // 2) crear los por defecto
                await Promise.all(
                    defaultProducts.map(dp =>
                        apiPost("/products", {
                            name: dp.name,
                            description: dp.description,
                            price: dp.price,
                            originalPrice: dp.originalPrice,
                            unit: dp.unit,
                            stock: dp.stock,
                            maxStock: dp.maxStock,
                            imageUrl: dp.imageUrl,
                            rating: dp.rating,
                            reviews: dp.reviews,
                            isNew: dp.isNew,
                            isOffer: dp.isOffer,
                            active: dp.available
                            // category: aqu√≠ podr√≠amos mapear a IDs reales cuando tengamos la API de categor√≠as integrada
                        })
                    )
                );

                await syncProductsFromBackendToLocalStorage();
                clearForm();
                showNotification('Productos restaurados en la base de datos', 'info');
            } catch (error) {
                console.error("Error restaurando productos por defecto:", error);
                showNotification('Error al restaurar productos por defecto', 'error');
            }
        }
    );
}

// Env√≠o del formulario: crear / editar en backend
document.getElementById('product-form').addEventListener('submit', async function (e) {
    e.preventDefault();

    const id = document.getElementById('product-id').value.trim();

    const formData = {
        name: document.getElementById('product-name').value.trim(),
        category: document.getElementById('product-category').value,
        description: document.getElementById('product-description').value.trim(),
        price: parseInt(document.getElementById('product-price').value),
        originalPrice: document.getElementById('product-original-price').value
            ? parseInt(document.getElementById('product-original-price').value)
            : null,
        unit: document.getElementById('product-unit').value,
        stock: parseInt(document.getElementById('product-stock').value),
        maxStock: parseInt(document.getElementById('product-max-stock').value),
        rating: parseFloat(document.getElementById('product-rating').value),
        imageUrl: document.getElementById('product-image').value.trim() || "",
        reviews: parseInt(document.getElementById('product-reviews').value) || 0,
        isNew: document.getElementById('product-is-new').checked,
        active: document.getElementById('product-available').checked,
    };

    // Validaciones de precio / stock...

    const body = {
        ...formData,
        isOffer: formData.originalPrice && formData.originalPrice > formData.price
    };

    try {
        if (id) {
            await apiPut(`/products/${id}`, body);
            showNotification("Producto actualizado correctamente", "success");
        } else {
            await apiPost("/products", body);
            showNotification("Producto agregado correctamente", "success");
        }

        await syncProductsFromBackendToLocalStorage();
        clearForm();
    } catch (error) {
        console.error("Error guardando producto:", error);
        showNotification("Error al guardar producto en el servidor", "error");
    }
});

        function logout() {
            console.log('logout() function called');
            try {
                showConfirmation(
                    '¬øEst√°s seguro de que deseas cerrar sesi√≥n?',
                    function() {
                        console.log('Logout confirmed');
                        localStorage.removeItem('ecomarket_logged_in');
                        localStorage.removeItem('ecomarket_user_type');
                        localStorage.removeItem('ecomarket_user_email');
                        localStorage.removeItem('ecomarket_user_name');
                        localStorage.removeItem('ecomarket_current_user');
                        
                        showNotification('Sesi√≥n cerrada correctamente', 'info');
                        setTimeout(() => {
                            console.log('Redirecting to login.html');
                            window.location.href = 'login.html';
                        }, 1500);
                    },
                    function() {
                        console.log('Logout cancelled');
                        showNotification('Sesi√≥n mantenida', 'info', 2000);
                    }
                );
            } catch (error) {
                console.error('Error in logout function:', error);
                showConfirmation(
                    'Confirmar Logout',
                    '¬øEst√°s seguro de que deseas cerrar sesi√≥n?',
                    function() {
                        localStorage.removeItem('ecomarket_logged_in');
                        localStorage.removeItem('ecomarket_user_type');
                        localStorage.removeItem('ecomarket_user_email');
                        localStorage.removeItem('ecomarket_user_name');
                        localStorage.removeItem('ecomarket_current_user');
                        
                        showNotification('Cerrando sesi√≥n...', 'success');
                        setTimeout(() => {
                            window.location.href = 'login.html';
                        }, 1500);
                    }
                );
            }
        }
        
        function checkAuth() {
            const isLoggedIn = localStorage.getItem('ecomarket_logged_in') === 'true';
            const userType = localStorage.getItem('ecomarket_user_type');
            
            if (!isLoggedIn || userType !== 'admin') {
                showNotification('Acceso denegado. Debes iniciar sesi√≥n como administrador.', 'error');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
                return false;
            }
            return true;
        }

                let adminOrders = [];

            async function loadProductsForAdmin() {
                try {
                const resp = await apiGet('/products?limit=500');
                const items = resp.items || resp;
            
                adminProducts = items;
                renderProductsTable();
                showNotification('Productos cargados correctamente', 'success');
                } catch (error) {
                console.error('Error cargando productos para admin:', error);
                showNotification('No se pudieron cargar los productos', 'error');
                }
            }

    async function loadOrders() {
        try {
            const statusFilter = document.getElementById('order-status-filter')?.value || '';
            const query = statusFilter ? `?status=${encodeURIComponent(statusFilter)}` : '';

            const orders = await apiGet(`/admin/orders${query}`);
            adminOrders = orders;
            renderOrdersList();
            updateReportsData();
            showNotification('Pedidos cargados correctamente', 'success');
        } catch (error) {
            console.error('Error cargando pedidos de backend:', error);
            showNotification('Error al cargar pedidos desde el servidor', 'error');
        }
    }

    function mapStatusToBadgeClass(status) {
        switch (status) {
            case 'CREADO':       return 'status-procesando';
            case 'PAGADO':       return 'status-confirmado';
            case 'EN_REPARTO':   return 'status-enviado';
            case 'ENTREGADO':    return 'status-entregado';
            case 'CANCELADO':    return 'status-cancelado';
            default:             return 'status-procesando';
        }
    }

    function renderOrdersList(filteredList = null) {
        const orders = filteredList || adminOrders;
        const container = document.getElementById('orders-list');
        const pendingCount = document.getElementById('pending-orders-count');

        if (!container) return;

        const pending = orders.filter(o => o.status !== 'ENTREGADO' && o.status !== 'CANCELADO');
        if (pendingCount) pendingCount.textContent = pending.length;

        if (!orders.length) {
            container.innerHTML = `
                <div class="text-center text-muted py-5">
                    <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                    <h5>No hay pedidos registrados</h5>
                    <p>Los pedidos aparecer√°n aqu√≠ cuando los clientes realicen compras.</p>
                </div>`;
            return;
        }

        const html = orders.map(order => {
            const createdAt = new Date(order.createdAt || Date.now());
            const user = order.user || {};
            const items = order.items || [];

            const itemsHtml = items.map(it => {
                const productName = it.product?.name || 'Producto';
                const qty = it.quantity || 0;
                const unitPrice = it.unitPrice ?? it.product?.price ?? 0;
                return `
                    <div class="order-item">
                        <span>${productName} (${qty})</span>
                        <span>$${(qty * unitPrice).toLocaleString('es-CL')}</span>
                    </div>
                `;
            }).join('') || `
                <div class="order-item">
                    <span>Sin productos</span>
                    <span>$0</span>
                </div>
            `;

            return `
            <div class="order-card">
                <div class="order-status">
                    <span class="status-badge ${mapStatusToBadgeClass(order.status)}">
                        ${order.status}
                    </span>
                </div>
                <div class="row">
                    <div class="col-md-3">
                        <strong>Pedido #${order._id}</strong><br>
                        <small class="text-muted">${createdAt.toLocaleDateString()}</small><br>
                        <small class="text-muted">${createdAt.toLocaleTimeString()}</small>
                    </div>
                    <div class="col-md-3">
                        <strong>Cliente:</strong><br>
                        ${user.name || 'Sin nombre'}<br>
                        <small class="text-muted">${user.email || ''}</small>
                    </div>
                    <div class="col-md-3">
                        <strong>Pago:</strong><br>
                        <small class="text-muted">Ref: ${order.paymentRef || 'N/A'}</small><br>
                        <small class="text-muted">Estado: ${order.status}</small>
                    </div>
                    <div class="col-md-3 text-end">
                        <div class="order-total">
                            Total: $${(order.total || 0).toLocaleString('es-CL')}
                        </div>
                        <div class="mt-2 mobile-order-actions d-flex justify-content-end gap-1">
                            <button class="btn btn-sm btn-outline-primary"
                                    onclick="viewOrderDetails('${order._id}')">
                                <i class="bi bi-eye"></i> Ver
                            </button>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-success dropdown-toggle"
                                        data-bs-toggle="dropdown">
                                    <i class="bi bi-gear"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item"
                                            onclick="updateOrderStatus('${order._id}', 'PAGADO')">Marcar como PAGADO</a></li>
                                    <li><a class="dropdown-item"
                                            onclick="updateOrderStatus('${order._id}', 'EN_REPARTO')">Marcar EN REPARTO</a></li>
                                    <li><a class="dropdown-item"
                                            onclick="updateOrderStatus('${order._id}', 'ENTREGADO')">Marcar ENTREGADO</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item text-danger"
                                            onclick="updateOrderStatus('${order._id}', 'CANCELADO')">Cancelar pedido</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="order-items mt-3">
                    <strong>Productos:</strong>
                    ${itemsHtml}
                </div>
            </div>`;
        }).join('');

        container.innerHTML = html;
    }

    // Actualizar estado de pedido en el backend
    async function updateOrderStatus(orderId, newStatus) {
        try {
            await apiPut(`/admin/orders/${orderId}/status`, { status: newStatus });
            showNotification('Estado del pedido actualizado', 'success');
            await loadOrders(); // recargar lista
        } catch (error) {
            console.error('Error actualizando estado del pedido:', error);
            showNotification('No se pudo actualizar el estado del pedido', 'error');
        }
    }

    // Ver detalles del pedido (versi√≥n simple usando backend)
    function viewOrderDetails(orderId) {
        const order = adminOrders.find(o => o._id === orderId);
        if (!order) {
            showNotification('Pedido no encontrado', 'error');
            return;
        }

        const user = order.user || {};
        const items = order.items || [];

        const itemsRows = items.map(it => {
            const productName = it.product?.name || 'Producto';
            const qty = it.quantity || 0;
            const unitPrice = it.unitPrice ?? it.product?.price ?? 0;
            return `
                <tr>
                    <td>${productName}</td>
                    <td>${qty}</td>
                    <td class="d-none-mobile">$${unitPrice.toLocaleString('es-CL')}</td>
                    <td>$${(qty * unitPrice).toLocaleString('es-CL')}</td>
                </tr>
            `;
        }).join('') || `
            <tr>
                <td colspan="4">Sin productos en este pedido</td>
            </tr>
        `;

        const createdAt = new Date(order.createdAt || Date.now());

        const modalHTML = `
        <div class="modal fade" id="orderDetailsModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                <h5 class="modal-title">Detalles del Pedido #${order._id}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                    <h6>Cliente</h6>
                    <p>
                        <strong>Nombre:</strong> ${user.name || 'Sin nombre'}<br>
                        <strong>Email:</strong> ${user.email || ''}<br>
                    </p>
                    </div>
                    <div class="col-md-6">
                    <h6>Pedido</h6>
                    <p>
                        <strong>Estado:</strong> ${order.status}<br>
                        <strong>Total:</strong> $${(order.total || 0).toLocaleString('es-CL')}<br>
                        <strong>Fecha:</strong> ${createdAt.toLocaleString()}
                    </p>
                    </div>
                </div>
                <h6>Productos</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                    <thead>
                        <tr>
                        <th>Producto</th>
                        <th>Cantidad</th>
                        <th class="d-none-mobile">Precio Unit.</th>
                        <th>Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${itemsRows}
                    </tbody>
                    </table>
                </div>
                </div>
                <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
            </div>
        </div>`;

        const existing = document.getElementById('orderDetailsModal');
        if (existing) existing.remove();
        document.body.insertAdjacentHTML('beforeend', modalHTML);

        const modal = new bootstrap.Modal(document.getElementById('orderDetailsModal'));
        modal.show();
    }

    function filterOrders() {
        const statusFilter = document.getElementById('order-status-filter')?.value || '';
        const customerSearch = (document.getElementById('customer-search')?.value || '').toLowerCase();

        let filtered = [...adminOrders];

        if (statusFilter) {
            const mapFrontToBackend = {
                'confirmado': 'PAGADO',
                'procesando': 'CREADO',
                'enviado': 'EN_REPARTO',
                'entregado': 'ENTREGADO'
            };
            const backendStatus = mapFrontToBackend[statusFilter];
            filtered = filtered.filter(o => o.status === backendStatus);
        }

        if (customerSearch) {
            filtered = filtered.filter(o => {
                const name = (o.user?.name || '').toLowerCase();
                const email = (o.user?.email || '').toLowerCase();
                return name.includes(customerSearch) || email.includes(customerSearch);
            });
        }

        renderOrdersList(filtered);
    }

    function clearOrderFilters() {
        if (document.getElementById('order-status-filter')) {
            document.getElementById('order-status-filter').value = '';
        }
        if (document.getElementById('payment-filter')) {
            document.getElementById('payment-filter').value = '';
        }
        if (document.getElementById('customer-search')) {
            document.getElementById('customer-search').value = '';
        }
        renderOrdersList();
    }

    // Actualizar lista de pedidos (bot√≥n "Actualizar")
    function refreshOrders() {
        loadOrders();
    }
    
    function generateReportData() {
        const orders = adminOrders || [];
        const products = getProducts() || [];

        const totalSales = orders.reduce((sum, o) => sum + (o.total || 0), 0);

        const productSales = {};
        orders.forEach(o => {
            (o.items || []).forEach(it => {
                const name = it.product?.name || 'Producto';
                const qty = it.quantity || 0;
                const unitPrice = it.unitPrice ?? it.product?.price ?? 0;
                if (!productSales[name]) {
                    productSales[name] = { quantity: 0, revenue: 0 };
                }
                productSales[name].quantity += qty;
                productSales[name].revenue += qty * unitPrice;
            });
        });

        const topProducts = Object.entries(productSales)
            .sort((a, b) => b[1].quantity - a[1].quantity)
            .slice(0, 5);

        const customerStats = {};
        orders.forEach(o => {
            const email = o.user?.email || 'sin-email';
            if (!customerStats[email]) {
                customerStats[email] = {
                    name: o.user?.name || email,
                    email,
                    orders: 0,
                    total: 0
                };
            }
            customerStats[email].orders += 1;
            customerStats[email].total += o.total || 0;
        });

        const topCustomers = Object.values(customerStats)
            .sort((a, b) => b.total - a.total)
            .slice(0, 5);

            const productByName = {};
            products.forEach(p => { productByName[p.name] = p; });

        const categorySales = {};
        orders.forEach(o => {
            (o.items || []).forEach(it => {
                const name = it.product?.name || 'Producto';
                const product = productByName[name];
                if (!product || !(product.categoryLabel || product.category)) return;
                const cat = product.categoryLabel || product.category;
                const qty = it.quantity || 0;
                const unitPrice = it.unitPrice ?? it.product?.price ?? 0;

                if (!categorySales[cat]) {
                    categorySales[cat] = { quantity: 0, revenue: 0 };
                }
                categorySales[cat].quantity += qty;
                categorySales[cat].revenue += qty * unitPrice;
            });
        });

        const pendingDeliveries = orders.filter(o => o.status !== 'ENTREGADO' && o.status !== 'CANCELADO').length;

        return {
            totalSales,
            topProducts,
            topCustomers,
            categorySales,
            pendingDeliveries,
            bestSeller: topProducts[0]?.[0] || 'N/A',
            topCustomer: topCustomers[0]?.name || 'N/A'
        };
    }

    function updateReportsData() {
        const data = generateReportData();

        const totalSalesEl = document.getElementById('total-sales');
        const bestSellerEl = document.getElementById('best-seller');
        const topCustomerEl = document.getElementById('top-customer');
        const pendingDeliveriesEl = document.getElementById('pending-deliveries');

        if (totalSalesEl) totalSalesEl.textContent = '$' + data.totalSales.toLocaleString('es-CL');
        if (bestSellerEl) bestSellerEl.textContent = data.bestSeller;
        if (topCustomerEl) topCustomerEl.textContent = data.topCustomer;
        if (pendingDeliveriesEl) pendingDeliveriesEl.textContent = data.pendingDeliveries;

        const topProductsList = document.getElementById('top-products-list');
        if (topProductsList) {
            if (!data.topProducts.length) {
                topProductsList.innerHTML = '<p class="text-muted">No hay datos disponibles</p>';
            } else {
                topProductsList.innerHTML = data.topProducts.map((p, idx) => {
                    const [name, stats] = p;
                    const rankClass = idx === 0 ? 'gold' : idx === 1 ? 'silver' : idx === 2 ? 'bronze' : '';
                    return `
                        <div class="ranking-item">
                            <div class="ranking-number ${rankClass}">${idx + 1}</div>
                            <div class="flex-grow-1">
                                <strong>${name}</strong><br>
                                <small class="text-muted">${stats.quantity} unidades vendidas</small>
                            </div>
                            <div class="text-end">
                                <strong>$${stats.revenue.toLocaleString('es-CL')}</strong>
                            </div>
                        </div>`;
                }).join('');
            }
        }

        const topCustomersList = document.getElementById('top-customers-list');
        if (topCustomersList) {
            if (!data.topCustomers.length) {
                topCustomersList.innerHTML = '<p class="text-muted">No hay datos disponibles</p>';
            } else {
                topCustomersList.innerHTML = data.topCustomers.map((c, idx) => {
                    const rankClass = idx === 0 ? 'gold' : idx === 1 ? 'silver' : idx === 2 ? 'bronze' : '';
                    return `
                        <div class="ranking-item">
                            <div class="ranking-number ${rankClass}">${idx + 1}</div>
                            <div class="flex-grow-1">
                                <strong>${c.name}</strong><br>
                                <small class="text-muted">${c.email}</small><br>
                                <small class="text-muted">${c.orders} pedidos</small>
                            </div>
                            <div class="text-end">
                                <strong>$${c.total.toLocaleString('es-CL')}</strong>
                            </div>
                        </div>`;
                }).join('');
            }
        }

        const categoryStatsEl = document.getElementById('category-stats');
        if (categoryStatsEl) {
            const entries = Object.entries(data.categorySales);
            if (!entries.length) {
                categoryStatsEl.innerHTML = '<div class="col-12"><p class="text-muted">No hay datos disponibles</p></div>';
            } else {
                const maxRevenue = Math.max(...entries.map(([, stats]) => stats.revenue));
                categoryStatsEl.innerHTML = entries.map(([cat, stats]) => `
                    <div class="col-md-6 mb-3">
                        <div class="category-item">
                            <div class="flex-grow-1">
                                <strong class="text-capitalize">${cat}</strong>
                                <div class="progress progress-category mt-1">
                                    <div class="progress-bar bg-success"
                                         style="width: ${(maxRevenue ? (stats.revenue / maxRevenue) * 100 : 0)}%"></div>
                                </div>
                                <small class="text-muted">${stats.quantity} productos vendidos</small>
                            </div>
                            <div class="text-end ms-3">
                                <strong>$${stats.revenue.toLocaleString('es-CL')}</strong>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }
    }

    function generateReport() {
        updateReportsData();
        showNotification('Informe actualizado con los datos m√°s recientes', 'success');
    }

    function exportReport() {
        const data = generateReportData();
        const reportData = {
            fecha: new Date().toISOString(),
            resumen: {
                ventasTotales: data.totalSales,
                productoMasVendido: data.bestSeller,
                clienteTop: data.topCustomer,
                pedidosPendientes: data.pendingDeliveries
            },
            topProductos: data.topProducts,
            topClientes: data.topCustomers,
            ventasPorCategoria: data.categorySales
        };

        const dataStr = JSON.stringify(reportData, null, 2);
        const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
        const fileName = `informe_ecomarket_${new Date().toISOString().split('T')[0]}.json`;

        const link = document.createElement('a');
        link.setAttribute('href', dataUri);
        link.setAttribute('download', fileName);
        link.click();

        showNotification('Informe exportado correctamente', 'success');
    }

document.addEventListener('DOMContentLoaded', async function() {
    if (!checkAuth()) return;
    
    await loadCategoriesForAdmin();

    await syncProductsFromBackendToLocalStorage();

    await loadOrders();
    updateReportsData();

    var tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    tooltips.forEach(function(el) {
        new bootstrap.Tooltip(el);
    });

    var collapseElements = document.querySelectorAll('[data-bs-toggle="collapse"]');
    collapseElements.forEach(function(element) {
        element.addEventListener('click', function() {
            var icon = this.querySelector('.collapse-icon');
            if (icon) {
                var isExpanded = this.getAttribute('aria-expanded') === 'true';
                icon.style.transform = isExpanded ? 'rotate(0deg)' : 'rotate(180deg)';
            }
        });
    });
});


    </script>
    <!-- Modal de Confirmaci√≥n para Limpiar Pedidos -->
    <div class="modal fade" id="clearOrdersModal" tabindex="-1" aria-labelledby="clearOrdersModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title" id="clearOrdersModalLabel">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>Confirmar Eliminaci√≥n
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center">
                        <i class="bi bi-trash3-fill text-danger" style="font-size: 3rem;"></i>
                        <h6 class="mt-3 mb-3">¬øEst√°s seguro de que deseas eliminar TODOS los pedidos?</h6>
                        <p class="text-muted">
                            Esta acci√≥n eliminar√° permanentemente todos los pedidos del sistema 
                            y no se puede deshacer.
                        </p>
                        <div class="alert alert-warning d-flex align-items-center" role="alert">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            <div>Esta acci√≥n es <strong>irreversible</strong></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-lg me-1"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-danger" id="confirmClearOrders">
                        <i class="bi bi-trash3-fill me-1"></i>S√≠, Eliminar Todo
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="assets/js/app.js"></script>
</body>
</html>
