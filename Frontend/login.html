
<!DOCTYPE html>
<html lang="es">
    <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acceder - EcoMarket</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link href="assets/css/style.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <style>
        .auth-container {
            min-height: 100vh;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        .auth-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .auth-tabs {
            border-bottom: 2px solid #f8f9fa;
            margin-bottom: 30px;
        }
        .auth-tab {
            background: none;
            border: none;
            padding: 15px 30px;
            color: #6c757d;
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            transition: all 0.3s ease;
        }
        .auth-tab.active {
            color: #008c5a;
            background: #f8f9fa;
            border-bottom: 3px solid #008c5a;
        }
        .password-toggle-btn {
            border-left: none;
            background: transparent;
            color: #6c757d;
        }
        .password-toggle-btn:hover {
            color: #008c5a;
            background: transparent;
        }
        .welcome-title {
            font-family: 'Dancing Script', cursive;
            font-size: 3.5rem;
            font-weight: 700;
            color: #008c5a;
            text-shadow: 2px 2px 4px rgba(0,140,90,0.3);
            margin-bottom: 10px;
            text-align: center;
            line-height: 1.2;
        }
        .welcome-subtitle {
            font-family: 'Poppins', sans-serif;
            font-size: 1.1rem;
            color: #6c757d;
            text-align: center;
            margin-bottom: 30px;
            font-weight: 400;
        }
        .eco-highlight {
            color: #28a745;
            font-weight: 600;
        }
        /* Fix para el bot√≥n hamburguesa en m√≥vil - OVERRIDE de style.css */
        .navbar-toggler {
            border: 1px solid rgba(255,255,255,0.3) !important;
            padding: 4px 8px !important;
            background: transparent !important;
        }
        .navbar-toggler:focus {
            box-shadow: 0 0 0 0.25rem rgba(255, 255, 255, 0.25) !important;
        }
        .navbar-toggler-icon {
            background-color: transparent !important;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba%28255, 255, 255, 0.9%29' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2.5' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e") !important;
            width: 1.5em !important;
            height: 1.5em !important;
            border-radius: 0 !important;
        }
        @media (max-width: 768px) {
            .welcome-title {
                font-size: 2.5rem;
            }
            .welcome-subtitle {
                font-size: 1rem;
            }
        }
    </style>
    </head>
    <body>
    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg navbar-dark sticky-top" style="background-color: #008c5a;">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="index.html">EcoMarket</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link" href="index.html">Inicio</a></li>
                    <li class="nav-item"><a class="nav-link" href="catalogo.html">Cat√°logo</a></li>
                    <li class="nav-item"><a class="nav-link" href="nosotros.html">Nosotros</a></li>
                    <li class="nav-item"><a class="nav-link" href="contacto.html">Contacto</a></li>
                </ul>
                <div class="d-flex align-items-center gap-3">
                    <!-- Dropdown del Usuario -->
                    <div class="dropdown">
                        <a href="#" class="text-white" role="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-person fs-5"></i>
                        </a>
                        <!-- Men√∫ desplegable del usuario (contenido din√°mico v√≠a JS) -->
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown" id="userDropdownMenu">
                            <!-- El contenido se genera din√°micamente con JavaScript -->
                        </ul>
                    </div>
                    
                    <a href="carrito.html" class="text-white position-relative">
                        <i class="bi bi-cart fs-5"></i>
                        <span id="cart-count" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="display: none;">
                            0
                        </span>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- FORMULARIO DE AUTENTICACI√ìN -->
    <div class="auth-container d-flex justify-content-center align-items-center py-5">
        <div class="auth-card p-5" style="width: 100%; max-width: 450px;">
            
            <!-- T√çTULO DE BIENVENIDA -->
            <div class="text-center mb-4">
                <h1 class="welcome-title">¬°Bienvenido!</h1>
                <p class="welcome-subtitle">
                    Accede a <span class="eco-highlight">EcoMarket</span> y disfruta de productos frescos y naturales üå±
                </p>
            </div>
            
            <!-- TABS PARA CAMBIAR ENTRE LOGIN Y REGISTRO -->
            <div class="auth-tabs text-center mb-4">
                <button type="button" class="auth-tab active" id="loginTab">Iniciar Sesi√≥n</button>
                <button type="button" class="auth-tab" id="registerTab">Registrarse</button>
            </div>

            <!-- FORMULARIO -->
            <form id="authForm">
                <!-- CAMPO NOMBRE (solo visible en registro) -->
                <div class="mb-3" id="nameField" style="display: none;">
                    <label for="name" class="form-label">Nombre completo</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-person"></i></span>
                        <input type="text" class="form-control" id="name" placeholder="Ingresa tu nombre completo">
                    </div>
                    <div class="invalid-feedback">Por favor, ingresa tu nombre.</div>
                </div>

                <!-- CAMPO EMAIL -->
                <div class="mb-3">
                    <label for="email" class="form-label">Correo electr√≥nico</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-envelope"></i></span>
                        <input type="text" class="form-control" id="email" placeholder="correo@ejemplo.com o admin" required>
                    </div>
                    <div class="invalid-feedback">Ingresa un correo v√°lido o "admin" para acceso administrativo.</div>
                </div>

                <!-- CAMPO CONTRASE√ëA -->
                <div class="mb-3">
                    <label for="password" class="form-label">Contrase√±a</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-lock"></i></span>
                        <input type="password" class="form-control" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required minlength="6" aria-describedby="passwordHelp">
                        <button class="btn btn-outline-secondary password-toggle-btn" type="button" id="togglePassword">
                            <i class="bi bi-eye" id="toggleIcon"></i>
                        </button>
                    </div>
                    <div class="invalid-feedback">La contrase√±a es obligatoria.</div>
                    <div id="passwordHelp" class="form-text text-muted">La contrase√±a debe tener al menos 6 caracteres.</div>
                </div>

                <!-- BOT√ìN PRINCIPAL -->
                <button type="submit" class="btn btn-success w-100 mb-3" id="submitBtn">
                    Iniciar Sesi√≥n
                </button>

                <!-- ENLACES ADICIONALES -->
                <div class="text-center">
                    <div class="mb-2">
                        <a href="#" class="text-muted text-decoration-none" id="forgotPassword" style="display: block;">¬øOlvidaste tu contrase√±a?</a>
                    </div>
                    
                    <a href="index.html" class="btn btn-outline-secondary w-100">
                        <i class="bi bi-arrow-left"></i> Volver al inicio
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL PARA RECUPERAR CONTRASE√ëA -->
    <div class="modal fade" id="forgotPasswordModal" tabindex="-1" aria-labelledby="forgotPasswordModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="forgotPasswordModalLabel">
                        <i class="bi bi-key-fill me-2"></i>Recuperar Contrase√±a
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body p-4">
                    <div id="forgotPasswordForm">
                        <div class="text-center mb-4">
                            <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 80px; height: 80px;">
                                <i class="bi bi-envelope-at-fill text-success" style="font-size: 2rem;"></i>
                            </div>
                            <h6 class="mt-3 mb-2">¬øOlvidaste tu contrase√±a?</h6>
                            <p class="text-muted small">
                                Ingresa tu correo electr√≥nico y te enviaremos un enlace para restablecer tu contrase√±a.
                            </p>
                        </div>
                        
                        <form id="resetPasswordForm">
                            <div class="mb-3">
                                <label for="resetEmail" class="form-label">Correo electr√≥nico</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="bi bi-envelope"></i>
                                    </span>
                                    <input type="email" class="form-control" id="resetEmail" placeholder="tu-email@ejemplo.com" required>
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-success">
                                    <i class="bi bi-send-fill me-2"></i>Enviar enlace de recuperaci√≥n
                                </button>
                                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                                    Cancelar
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- CONFIRMACI√ìN DE ENV√çO -->
                    <div id="resetConfirmation" style="display: none;">
                        <div class="text-center">
                            <div class="bg-success bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px;">
                                <i class="bi bi-check-circle-fill text-success" style="font-size: 2rem;"></i>
                            </div>
                            <h6 class="text-success mb-2">¬°Correo enviado!</h6>
                            <p class="text-muted small mb-4">
                                Hemos enviado un enlace de recuperaci√≥n a <strong id="sentEmailAddress"></strong>
                            </p>
                            <div class="alert alert-info small">
                                <i class="bi bi-info-circle me-2"></i>
                                Revisa tu bandeja de entrada y spam. El enlace expira en 24 horas.
                            </div>
                            <button type="button" class="btn btn-outline-secondary w-100" data-bs-dismiss="modal">
                                Entendido
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer Container - El footer se carga din√°micamente -->
    <div id="footer-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/api.js"></script>
    <script src="assets/js/app.js"></script>
    
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            // === ELEMENTOS DEL DOM ===
            const loginTab = document.getElementById('loginTab');
            const registerTab = document.getElementById('registerTab');
            const nameField = document.getElementById('nameField');
            const nameInput = document.getElementById('name');
            const submitBtn = document.getElementById('submitBtn');
            const forgotPassword = document.getElementById('forgotPassword');
            const togglePassword = document.getElementById('togglePassword');
            const passwordInput = document.getElementById('password');
            const toggleIcon = document.getElementById('toggleIcon');
            const authForm = document.getElementById('authForm');
            const emailInput = document.getElementById('email');

            let isLoginMode = true;

            // === VALIDACI√ìN DIN√ÅMICA DEL EMAIL ===
            emailInput.addEventListener('input', function() {
                const value = this.value.trim();
                const lowerValue = value.toLowerCase();
                
                // Si est√° escribiendo "admin", cambiar el placeholder y remover validaci√≥n de email
                if (lowerValue === 'admin') {
                    this.placeholder = 'admin (acceso administrativo)';
                    this.classList.remove('is-invalid');
                    this.classList.add('is-valid');
                    this.setCustomValidity(''); // Limpiar validaci√≥n personalizada
                } else if (lowerValue.startsWith('adm') && lowerValue.length < 5) {
                    this.placeholder = 'admin (acceso administrativo)';
                    this.classList.remove('is-invalid', 'is-valid');
                } else if (value.includes('@')) {
                    this.placeholder = 'correo@ejemplo.com';
                    // Validar formato de email
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (emailRegex.test(value)) {
                        this.classList.remove('is-invalid');
                        this.classList.add('is-valid');
                    } else {
                        this.classList.remove('is-valid');
                        this.classList.add('is-invalid');
                    }
                } else if (value.length > 0) {
                    this.placeholder = 'correo@ejemplo.com o admin';
                    this.classList.remove('is-valid', 'is-invalid');
                } else {
                    this.placeholder = 'correo@ejemplo.com o admin';
                    this.classList.remove('is-valid', 'is-invalid');
                }
            });

            // === VALIDACI√ìN ESPEC√çFICA PARA MODO REGISTRO ===
            function updateEmailValidationForMode() {
                if (!isLoginMode && emailInput.value.toLowerCase() === 'admin') {
                    emailInput.classList.remove('is-valid');
                    emailInput.classList.add('is-invalid');
                    emailInput.placeholder = 'No puedes usar "admin" para registro';
                } else if (!isLoginMode) {
                    emailInput.placeholder = 'correo@ejemplo.com';
                } else {
                    emailInput.placeholder = 'correo@ejemplo.com o admin';
                }
            }

            // === FUNCI√ìN PARA CAMBIAR ENTRE LOGIN Y REGISTRO ===
            function switchMode(isLogin) {
                isLoginMode = isLogin;
                console.log('DEBUG: switchMode ->', isLogin ? 'login' : 'register');
                
                if (isLogin) {
                    // Modo Login
                    loginTab.classList.add('active');
                    registerTab.classList.remove('active');
                    nameField.style.display = 'none';
                    nameInput.removeAttribute('required');
                    submitBtn.textContent = 'Iniciar Sesi√≥n';
                    forgotPassword.style.display = 'block';
                    document.title = 'Iniciar Sesi√≥n - EcoMarket';
                } else {
                    // Modo Registro
                    registerTab.classList.add('active');
                    loginTab.classList.remove('active');
                    nameField.style.display = 'block';
                    nameInput.setAttribute('required', 'required');
                    submitBtn.textContent = 'Crear Cuenta';
                    forgotPassword.style.display = 'none';
                    document.title = 'Registrarse - EcoMarket';
                }
                
                // Actualizar validaci√≥n del email seg√∫n el modo
                updateEmailValidationForMode();
            }

            // === EVENTOS DE LOS TABS ===
            loginTab.addEventListener('click', () => switchMode(true));
            registerTab.addEventListener('click', () => switchMode(false));

            // === FUNCI√ìN PARA MOSTRAR/OCULTAR CONTRASE√ëA ===
            togglePassword.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                const isPassword = passwordInput.type === 'password';
                
                if (isPassword) {
                    passwordInput.type = 'text';
                    toggleIcon.classList.remove('bi-eye');
                    toggleIcon.classList.add('bi-eye-slash');
                } else {
                    passwordInput.type = 'password';
                    toggleIcon.classList.remove('bi-eye-slash');
                    toggleIcon.classList.add('bi-eye');
                }
            });

            // === FUNCI√ìN PARA VALIDAR EMAIL ===
            function isValidEmailOrAdmin(email) {
                // Si es "admin", convertir al email real del admin
                if (email.toLowerCase() === 'admin') {
                    return true;
                }
                // Si es el email completo del admin, tambi√©n es v√°lido
                if (email.toLowerCase() === 'admin@ecomarket.com') {
                    return true;
                }
                // Si no es admin, debe ser un email v√°lido
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailRegex.test(email);
            }
            
            // === MANEJO DEL FORMULARIO (integrado con backend) ===
                        authForm.addEventListener('submit', async (e) => {
                                e.preventDefault();

                        let email = emailInput.value.trim();
                        const password = passwordInput.value;
                        const name = nameInput.value.trim();

                            // Validaci√≥n b√°sica
                                if (!email || !password || (!isLoginMode && !name)) {
                                showNotification('Por favor completa todos los campos obligatorios.', 'warning');
                                return;
                                }

                            // Validaci√≥n m√≠nima de longitud de contrase√±a
                                if (password && password.length < 6) {
                                showNotification('La contrase√±a debe tener al menos 6 caracteres.', 'warning');
                                return;
                                }
                
              // En registro NO permitimos "admin"
                if (!isLoginMode && email.toLowerCase() === 'admin') {
                showNotification('No puedes registrarte con el nombre "admin".', 'warning');
                return;
                }
                
              // Si es login y escribe "admin", convertir al email del admin
                if (isLoginMode && email.toLowerCase() === 'admin') {
                    email = 'admin@ecomarket.com';
                }
                
              // Validar formato de correo (manteniendo tu funci√≥n de validaci√≥n)
                if (!isValidEmailOrAdmin(email)) {
                const msg = isLoginMode
                    ? 'Ingresa un correo v√°lido o usa "admin" solo si tu usuario admin ya existe en el sistema.'
                    : 'Ingresa un correo electr√≥nico v√°lido para el registro.';
                showNotification(msg, 'warning');
                return;
                }
                
                try {
                if (isLoginMode) {
                  // ===== LOGIN contra backend =====
                    const body = { email, password };
                    const response = await apiPost('/auth/login', body);
                    
                    console.log('Respuesta del servidor:', response);
                    
                    // El backend devuelve { ok: true, data: { token, user } }
                    const data = response.data || response;
                
                    if (data.token) {
                        localStorage.setItem('ecomarket_token', data.token);
                    }
                    if (data.user) {
                        localStorage.setItem('ecomarket_user', JSON.stringify(data.user));
                        localStorage.setItem('ecomarket_logged_in', 'true');
                        // Normalizar el role (el backend usa ADMIN/CUSTOMER en may√∫sculas)
                        const normalizedRole = (data.user.role || 'CUSTOMER').toUpperCase();
                        const userType = normalizedRole === 'ADMIN' ? 'admin' : 'user';
                        localStorage.setItem('ecomarket_user_type', userType);
                        localStorage.setItem('ecomarket_user_email', data.user.email);
                        localStorage.setItem('ecomarket_user_name', data.user.name);
                    }
                    
                    const userName = data.user?.name || 'Usuario';
                    const isAdmin = data.user && (data.user.role === 'ADMIN' || data.user.role === 'admin');
                    
                    showNotification(`¬°Bienvenido ${userName}!`, 'success');
                    
                    // Actualizar el men√∫ de usuario inmediatamente
                    if (typeof updateNavbar === 'function') {
                        updateNavbar();
                    }
                    
                    setTimeout(() => {
                        window.location.href = isAdmin ? 'admin.html' : 'index.html';
                    }, 1200);
                    
                } else {
                  // ===== REGISTRO contra backend =====
                    const body = { name, email, password };
                    const response = await apiPost('/auth/register', body);
                    
                    console.log('Respuesta de registro:', response);
                    
                    showNotification('Cuenta creada correctamente. Ahora puedes iniciar sesi√≥n.', 'success');
                
                  // Cambiamos a modo login y dejamos el correo escrito
                    switchMode(true);
                    emailInput.value = email;
                    passwordInput.value = '';
                }
                } catch (err) {
                    console.error('Error en login/registro:', err);
                    showNotification(err.message || 'Error al procesar la solicitud.', 'error');
                }

            });



            // === MODAL DE RECUPERAR CONTRASE√ëA ===
            const forgotPasswordLink = document.getElementById('forgotPassword');
            const resetPasswordForm = document.getElementById('resetPasswordForm');
            const resetConfirmation = document.getElementById('resetConfirmation');
            const forgotPasswordFormDiv = document.getElementById('forgotPasswordForm');
            
            // Abrir modal al hacer click en "¬øOlvidaste tu contrase√±a?"
            forgotPassword.addEventListener('click', (e) => {
                e.preventDefault();
                const modal = new bootstrap.Modal(document.getElementById('forgotPasswordModal'));
                modal.show();
            });

            // Manejar env√≠o del formulario de recuperaci√≥n
            resetPasswordForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('resetEmail').value;
                
                // Simular env√≠o del correo (aqu√≠ ir√≠a la llamada al backend)
                console.log('Enviando correo de recuperaci√≥n a:', email);
                
                // Mostrar confirmaci√≥n
                document.getElementById('sentEmailAddress').textContent = email;
                forgotPasswordFormDiv.style.display = 'none';
                resetConfirmation.style.display = 'block';
                
                // Simular creaci√≥n del enlace de recuperaci√≥n
                const resetToken = generateResetToken();
                const resetLink = `${window.location.origin}${window.location.pathname.replace('login.html', 'reset-password.html')}?token=${resetToken}&email=${encodeURIComponent(email)}`;
                
                console.log('Enlace de recuperaci√≥n generado:', resetLink);
                console.log('üìß [SIMULADO] Correo enviado a:', email);
                console.log('üîó [SIMULADO] Enlace:', resetLink);
                
            });

            // Funci√≥n para generar token simulado
            function generateResetToken() {
                return Math.random().toString(36).substring(2, 15) + 
                    Math.random().toString(36).substring(2, 15);
            }

            // Reset modal cuando se cierre
            document.getElementById('forgotPasswordModal').addEventListener('hidden.bs.modal', () => {
                resetPasswordForm.reset();
                forgotPasswordFormDiv.style.display = 'block';
                resetConfirmation.style.display = 'none';
            });

            // === CARGAR FOOTER ===
            setTimeout(() => {
                const footer = document.querySelector('#footer-container footer');
                if (!footer && typeof loadFooter === 'function') {
                    loadFooter();
                }
            }, 500);
            
            // === ACTUALIZAR NAVBAR CON ESTADO DE SESI√ìN ===
            // Verificar si el usuario ya est√° logueado y actualizar el men√∫
            if (typeof updateNavbar === 'function') {
                updateNavbar();
            } else if (typeof updateUserDropdown === 'function') {
                updateUserDropdown();
            }

        });
    </script>
    </body>
</html>
